import os
import requests
import random

from linebot import LineBotApi, WebhookHandler
from linebot.models import MessageEvent, TextMessage, LocationMessage, TemplateSendMessage, ButtonsTemplate, URITemplateAction

# 初始化 Line Bot API
line_bot_api = LineBotApi('ZXxMakoI5GNuejiC7Igzm1wvqw3vDxHGRlicvQPM1qizx9eqUJSouLzo1rbTZxo24IWBi0E3AP8lBSOj7SRVt0GkK5Duowbfjn/Zgn8YPHKYfxJC90NHFr8ihfry5YKOjFiNPkHv+XGPydkBv5F0UAdB04t89/1O/w1cDnyilFU=')
handler = WebhookHandler('4226f38b9cd8bce4d0417d29d575f750')

# Google Maps API 金鑰
GOOGLE_API_KEY = 'AIzaSyD5sX433QilH8IVyjPiIpqqzJAy_dZrLvE'

# 處理接收到的訊息事件
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    # 如果訊息是「推薦附近餐廳」
    if event.message.text == '推薦附近餐廳':
        # 回覆訊息
        reply_nearby_restaurants(event)

# 回覆附近餐廳的函式
def reply_nearby_restaurants(event):
    # 取得使用者發送的地理位置
    location = get_user_location(event)
    if location:
        # 使用 Google Places API 搜尋附近餐廳
        url = f'https://maps.googleapis.com/maps/api/place/nearbysearch/json?key={GOOGLE_API_KEY}&location={location}&radius=1000&type=restaurant&language=zh-TW'
        response = requests.get(url)
        results = response.json().get('results', [])

        # 如果找到了餐廳，隨機選擇一個
        if results:
            restaurant = random.choice(results)
            send_restaurant_message(event, restaurant)
        else:
            line_bot_api.reply_message(event.reply_token, TextMessage(text="附近沒有找到餐廳。"))

# 取得使用者傳送的地理位置
def get_user_location(event):
    if isinstance(event.message, LocationMessage):
        return f"{event.message.latitude},{event.message.longitude}"
    else:
        line_bot_api.reply_message(event.reply_token, TextMessage(text="請先傳送您的地理位置。"))

# 發送餐廳訊息
def send_restaurant_message(event, restaurant):
    message = TemplateSendMessage(
        alt_text=restaurant['name'],
        template=ButtonsTemplate(
            thumbnail_image_url='THUMBNAIL_IMAGE_URL',
            title=restaurant['name'],
            text=restaurant['vicinity'],
            actions=[
                URITemplateAction(
                    label='查看地圖',
                    uri=f"https://www.google.com/maps/search/?api=1&query={restaurant['geometry']['location']['lat']},{restaurant['geometry']['location']['lng']}&query_place_id={restaurant['place_id']}"
                )
            ]
        )
    )
    line_bot_api.reply_message(event.reply_token, message)

# 主程式入口
if __name__ == "__main__":
    app.run(debug=True)
